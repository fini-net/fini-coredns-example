# FINI coredns example

![GitHub Issues](https://img.shields.io/github/issues/fini-net/fini-coredns-example)
![GitHub Pull Requests](https://img.shields.io/github/issues-pr/fini-net/fini-coredns-example)
![GitHub License](https://img.shields.io/github/license/fini-net/fini-coredns-example)
![GitHub watchers](https://img.shields.io/github/watchers/fini-net/fini-coredns-example)

An example container with coredns serving files generated by
[dnscontrol](https://github.com/StackExchange/dnscontrol).

## Status

The zone files are build with dnscontrol and can be served
locally with coredns.

- TODO: try ghcr for container registry (ðŸš§ in progress)
- TODO: build test suite (ðŸ¤· very open to suggestions)

## Usage

Check out [conf/coredns](conf/coredns) to see an example of serving
the domains in this repo.

Feel free to tweak the examples in `dns/*.js` and
run `just push` to regenerate the BIND files.

The [development processs](.github/CONTRIBUTING.md#development-process)
documents the subcommands available in `just` to work with this repo.

### Working with the container

To generate the container on your local machine run `just build_con`.

To run the built container run `just run_con`.  A DNS server should be
available on port 1029.  You can see it working with `dig` like so:

```ShellSession
% dig @localhost -p 1029 www.example.com

; <<>> DiG 9.10.6 <<>> @localhost -p 1029 www.example.com
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3344
;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 4, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.example.com.               IN      A

;; ANSWER SECTION:
www.example.com.        3600    IN      CNAME   server1.example.com.
server1.example.com.    3600    IN      A       10.0.0.101

;; AUTHORITY SECTION:
example.com.            3600    IN      NS      ns0.example.com.
example.com.            3600    IN      NS      ns1.example.com.
example.com.            3600    IN      NS      ns2.example.com.
example.com.            3600    IN      NS      ns3.example.com.

;; Query time: 6 msec
;; SERVER: ::1#1029(::1)
;; WHEN: Sat Jul 05 20:26:48 PDT 2025
;; MSG SIZE  rcvd: 287
```

That is the same CNAME and IP that you can see in the
[zone file](dns/zones/example.com.zone).

#### Easier working wih the container

To save you some typing you could run `just test_con` to get this
experience:

```ShellSession
% just test_con
Expect to see in dig output:
;; ANSWER SECTION:
www.example.com.        3600    IN      CNAME   server1.example.com.
server1.example.com.    3600    IN      A       10.0.0.101

dig @localhost -p 1029 www.example.com

; <<>> DiG 9.10.6 <<>> @localhost -p 1029 www.example.com
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36425
;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 4, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.example.com.               IN      A

;; ANSWER SECTION:
www.example.com.        3600    IN      CNAME   server1.example.com.
server1.example.com.    3600    IN      A       10.0.0.101

;; AUTHORITY SECTION:
example.com.            3600    IN      NS      ns0.example.com.
example.com.            3600    IN      NS      ns1.example.com.
example.com.            3600    IN      NS      ns2.example.com.
example.com.            3600    IN      NS      ns3.example.com.

;; Query time: 2 msec
;; SERVER: ::1#1029(::1)
;; WHEN: Thu Jul 10 12:37:44 PDT 2025
;; MSG SIZE  rcvd: 287
```

Looks great until we can automate it!â„¢

#### Container commands reference

For direct podman usage without `just`:

```bash
# Run the container (DNS server on port 1029)
podman run -d --name corednstest -p 1029:53/udp fini-coredns-example

# Test the DNS server
dig @localhost -p 1029 www.example.com

# Stop and clean up
podman stop corednstest
podman rm corednstest

# Inspect container metadata
podman inspect fini-coredns-example | jq '.[0].Labels'
```

## Standards

The domains and IPs in the examples contained in this repo should comply with

- [RFC2606: Reserved Top Level DNS Names](https://www.rfc-editor.org/rfc/rfc2606.html)
- [RFC1918: Address Allocation for Private Internets](https://www.rfc-editor.org/rfc/rfc1918.html)
- [RFC4193: Unique Local IPv6 Unicast Addresses](https://www.rfc-editor.org/rfc/rfc4193.txt)

to avoid interfering with any existing infrastructure.

## Contibuting

- [Code of Conduct](.github/CODE_OF_CONDUCT.md)
- [Contributing Guide](.github/CONTRIBUTING.md) includes a step-by-step guide to our
  [development processs](.github/CONTRIBUTING.md#development-process).

## Support & Security

- [Getting Support](.github/SUPPORT.md)
- [Security Policy](.github/SECURITY.md)

## Thanks

- Robb Manes wrote
  [Running CoreDNS as a DNS Server in a Container](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
  which walks you how to do something similar for yourself.
- This [ServerFault answer](https://serverfault.com/a/216611/205542) helped me find RFC4193
  for the safe IPv6 address range.
- [networkupstools](https://github.com/networkupstools/nut/wiki/Building-NUT-integration-for-Home-Assistant)
  shows how to set a lot of metadata during your container build.
- Kudos to Jason Hall for [documenting the nice way to login to ghcr](https://github.com/cli/cli/pull/8558),
  but it doesn't work (yet?) so I had to create a PAT after all.
